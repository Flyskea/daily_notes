在本章中，您被要求设计一个信息流系统。什么是信息流？根据 Facebook 帮助页面的介绍，“信息流是您主页中不断更新的故事列表。信息流包括来自您在 Facebook 上关注的人、页面和群组的状态更新、照片、视频、链接、应用程序活动和点赞” [1](https://www.facebook.com/help/327131014036297/)。这是一个流行的面试题。类似的常见问题包括：设计 Facebook 信息流、Instagram 信息流、Twitter 时间线 (timeline)等。

![](../picture/Pasted%20image%2020230628154315.png)

## 步骤 1 - 理解问题并确定设计范围

首先要理解面试官在要求您设计信息流系统时的意图，至少要弄清楚要支持哪些功能。以下是候选人和面试官之间的交互示例：

候选人：这是一个移动应用程序吗？还是一个 Web 应用程序？还是两者都有？

面试官：两者都有。

候选人：有哪些重要的功能？

面试官：用户可以发布帖子并在信息流页面上查看朋友的帖子。

候选人：信息流是按照时间顺序排列还是按照某个特定的顺序（例如主题分数）排列？例如，来自您亲密朋友的帖子得分更高。

面试官：为了简单起见，让我们假设订阅按照时间顺序反向排列。

候选人：一个用户最多可以有多少个朋友？

面试官：5000。

候选人：流量有多大？

面试官：1000 万 DAU。

候选人：信息流可以包含图像、视频或只能包含文本吗？

面试官：它可以包含媒体文件，包括图像和视频。

现在您已经收集到了需求，我们将专注于设计系统。

## 步骤 2 - 提出高层设计并获得认可

该设计分为两个流程：发布信息流和构建信息流。

- 发布信息流：当用户发布帖子时，相应的数据会被写入缓存和数据库。该帖子将会出现在她的朋友们的信息流中。
- 构建信息流：为了简单起见，我们假设信息流是通过按时间顺序聚合朋友的帖子来构建的。

### 信息流 API

信息流API是客户端与服务器进行通信的主要方式。这些API基于HTTP，允许客户端执行各种操作，包括发布状态、检索信息流、添加朋友等。我们讨论两个最重要的API：发布信息流API和检索信息流API。

#### 发布信息流 API

为了发布帖子，将发送一个HTTP POST请求到服务器。API如下所示：

POST /v1/me/feed

参数：

- content：内容是帖子的文本。
- auth_token：用于验证 API 请求。

#### 检索信息流 API

用于检索信息流的API如下所示：

GET /v1/me/feed

参数：

- auth_token：用于验证 API 请求。

### 发布信息流

图11-2显示了发布信息流流程的高层设计。

![](../picture/Pasted%20image%2020230628155211.png)

- 用户：用户可以在浏览器或移动应用程序中查看信息流。
- 负载均衡器：将流量分配到 Web 服务器。
- Web 服务器：Web 服务器将流量重定向到不同的内部服务。
- 发布服务：将帖子持久化到数据库和缓存中。
- 扇出服务：将新内容推送到朋友的信息流中。信息流数据存储在缓存中以进行快速检索。
- 通知服务：通知朋友新内容可用，并发送推送通知。

### 信息流构建

在本节中，我们将讨论信息流在幕后是如何构建的。图11-3显示了高层设计：

![](../picture/Pasted%20image%2020230628155445.png)

- 用户：用户发送一个请求来检索她的信息流。请求的格式如下：`/v1/me/feed`。
- 负载均衡器：将流量重定向到Web服务器。
- Web服务器：Web服务器将请求路由到信息流服务。
- 信息流服务：信息流服务从缓存中获取信息流。
- 信息流缓存：存储用于渲染信息流所需的信息流 ID。

## 步骤 3 - 深入设计

高层设计简要介绍了两个流程：发布信息流和构建信息流。在这里，我们将更深入地讨论这些主题。

### 深入发布信息流

图11-4概述了发布信息流的详细设计。我们已经在高层设计中讨论了大多数组件，现在我们将重点关注两个组件：Web 服务器和扇出服务。

![](../picture/Pasted%20image%2020230628160009.png)

#### Web服务器

除了与客户端通信外，Web服务器还执行身份验证和速率限制。只有使用有效的auth_token登录的用户才允许发布帖子。系统限制用户在特定时间内可以发布的帖子数量，这对于防止垃圾邮件和滥用内容非常重要。

#### 扇出服务

扇出是将帖子传递给所有朋友的过程。有两种扇出模型：写入时扇出（也称为推送模型）和读取时扇出（也称为拉取模型）。这两种模型都有优缺点。我们将解释它们的工作流程并探讨支持我们系统的最佳方法。

##### 写入时扇出

采用此方法，在写入时预计算信息流。一篇新帖子在发布后立即传递到朋友的缓存中。

优点：

- 信息流实时生成，可以立即推送给朋友。
- 获取信息流很快，因为在写入时预计算了信息流。

缺点：

- 如果用户有很多朋友，则获取好友列表并为所有朋友生成信息流是缓慢和耗时的。这被称为热点问题。
- 对于不活跃的用户或很少登录的用户，预计算信息流会浪费计算资源。

##### 读取时扇出

信息流在读取时生成。这是一个按需模型。当用户加载她的首页时，最新的帖子会被拉取。

优点：

- 对于不活跃的用户或很少登录的用户，读取时扇出更有效，因为不会浪费计算资源。
- 数据不会被推送给朋友，所以没有热点问题。

缺点：

- 获取信息流很慢，因为信息流没有预计算。

我们采用混合方法，以获得两种方法的优点并避免它们的缺点。由于快速获取信息流至关重要，我们为大多数用户使用推送模型。对于名人或拥有许多朋友/粉丝的用户，我们允许关注者按需拉取新闻内容，以避免系统过载。一致性哈希是一种有用的技术，可减轻热点问题，因为它有助于更均匀地分配请求/数据。让我们仔细看一下扇出服务，如图11-5所示。

![](../picture/Pasted%20image%2020230628160345.png)

扇出服务的工作方式如下：

1. 从图数据库中获取好友 ID。图数据库适用于管理好友关系和好友推荐。对于想要了解更多此概念的读者，可以参考参考资料 [2](http://geekswithblogs.net/brendonpage/archive/2015/10/26/friend-of-friendrecommendations-with-neo4j.aspx)。
2. 从用户缓存中获取好友信息。然后，系统根据用户设置过滤好友。例如，如果您将某个人静音，即使您仍然是朋友，她的帖子也不会出现在您的信息流中。另一个原因是，用户可以有选择地与特定朋友分享信息或隐藏它。
3. 将好友列表和新帖子ID发送到消息队列。
4. 扇出工作者从消息队列中获取数据，并将信息流数据存储在信息流缓存中。您可以将信息流缓存视为<post_id, user_id>映射表。每当发布新帖子时，它都会附加到信息流表中，如图11-6所示。如果在缓存中存储整个用户和帖子对象，内存消耗可能会变得非常大。因此，只存储ID。为了保持内存大小较小，我们设置了一个可配置的限制。用户浏览数千条信息流的机会很小。大多数用户只对最新的内容感兴趣，因此缓存未命中率很低。
5. 在信息流缓存中存储<post_id, user_id>。图11-6显示了缓存中信息流的示例。

![](../picture/Pasted%20image%2020230628160506.png)

### 深入信息流检索

如图11-7所示，媒体内容（图片、视频等）存储在 CDN 中，以便快速检索。让我们看看客户端如何检索信息流。

![](../picture/Pasted%20image%2020230628160919.png)

1. 用户发送检索她的信息流的请求。请求的格式如下：`/v1/me/feed`。
2. 负载均衡器将请求重新分配给Web服务器。
3. Web服务器调用信息流服务来获取信息流。
4. 信息流服务从信息流缓存中获取帖子ID列表。
5. 用户的信息流不仅仅是一组订阅ID列表。它包含用户名、个人资料图片、帖子内容、帖子图片等。因此，信息流服务从缓存（用户缓存和帖子缓存）中获取完整的用户和帖子对象，以构建完全填充的信息流。
6. 完全填充的信息流以JSON格式返回给客户端进行渲染。

### 缓存架构

缓存对于信息流系统非常重要。我们将缓存层分为五层，如图11-8所示。

- 信息流：存储信息流的ID。
- 内容：存储每个帖子的数据。热门内容存储在热缓存中。
- 社交图谱：存储用户关系数据。
- 操作：存储用户是否喜欢帖子、回复帖子或对帖子进行其他操作的信息。
- 计数器：存储喜欢、回复、关注者、关注等计数器。

## 步骤4 - 总结

本章中，我们设计了一个信息流系统。我们的设计包含两个流程：信息流发布和信息流检索。像任何系统设计面试问题一样，没有完美的设计系统的方法。每个公司都有其独特的限制，您必须设计一个适合这些限制的系统。了解您的设计和技术选择的权衡是很重要的。如果还有几分钟的时间，您可以谈论可伸缩性问题。为避免重复讨论，下面仅列出高层次的话题。

- 扩展数据库：
    - 垂直扩展与水平扩展
    - SQL与NoSQL
    - 主从复制
    - 读副本
    - 一致性模型
    - 数据库分片
- 其他话题：
    - 保持Web层无状态
    - 尽可能缓存数据
    - 支持多个数据中心
    - 使用消息队列解耦组件
    - 监控关键指标。例如，在高峰时段的QPS和用户刷新其信息流时的延迟都是有趣的监控指标。

恭喜您到达这一步！现在请给自己一个鼓励。干得好！